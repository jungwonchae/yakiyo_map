<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>Yakiyo Kakao Map</title>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100%;
      }
    </style>

    <!-- Kakao Maps JS SDK -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=76db1590d48d0c7bf7d8a1b4ce4147e4&autoload=false"></script>

    <script>
      let map = null;
      let markers = [];
      let myMarker = null; // ë‚´ ìœ„ì¹˜ ë§ˆì»¤

      // Yakiyo ì•½êµ­ ë§ˆì»¤ ì•„ì´ì½˜ (Vercel public í´ë” ê¸°ì¤€)
      const PHARMACY_ICON_URL = "/pill-marker.png"; // public/pill-marker.png
      let pharmacyMarkerImage = null;

      function log() {
        console.log.apply(console, arguments);
      }

      function initMap() {
        kakao.maps.load(function () {
          const container = document.getElementById("map");
          const options = {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // ê¸°ë³¸: ì„œìš¸
            level: 5, // ê¸°ë³¸ ì¤Œ
          };
          map = new kakao.maps.Map(container, options);
          log("ğŸ—º Kakao Map ì´ˆê¸°í™” ì™„ë£Œ");

          // ì•½êµ­ ë§ˆì»¤ ì´ë¯¸ì§€ ì¤€ë¹„
          const size = new kakao.maps.Size(32, 32);
          const offset = new kakao.maps.Point(16, 32);
          pharmacyMarkerImage = new kakao.maps.MarkerImage(
            PHARMACY_ICON_URL,
            size,
            { offset: offset }
          );
        });
      }

      // Flutterì—ì„œ ì´ˆê¸° ì„¸íŒ… / ì „ì²´ ë§ˆì»¤ í‘œì‹œí•  ë•Œ í˜¸ì¶œ
      window.setCenterAndMarkers = function (
        centerLat,
        centerLng,
        markersJson,
        zoomLevel
      ) {
        if (!map) {
          log("âš ï¸ map ì•„ì§ ì¤€ë¹„ ì•ˆ ë¨. ì ì‹œ í›„ ë‹¤ì‹œ í˜¸ì¶œ í•„ìš”");
          return;
        }

        const center = new kakao.maps.LatLng(centerLat, centerLng);

        // ì´ì „ ë§ˆì»¤ ì‚­ì œ
        markers.forEach((m) => m.setMap(null));
        markers = [];
        if (myMarker) {
          myMarker.setMap(null);
          myMarker = null;
        }

        // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ (ê¸°ë³¸ í•€)
        myMarker = new kakao.maps.Marker({
          map: map,
          position: center,
          title: "ë‚´ ìœ„ì¹˜",
        });

        // bounds ê³„ì‚°
        let bounds = new kakao.maps.LatLngBounds();
        bounds.extend(center);

        try {
          const list = JSON.parse(markersJson);

          list.forEach((item) => {
            const pos = new kakao.maps.LatLng(item.lat, item.lng);
            const marker = new kakao.maps.Marker({
              map: map,
              position: pos,
              title: item.name,
              image: pharmacyMarkerImage, // Yakiyo ì•„ì´ì½˜
            });
            markers.push(marker);
            bounds.extend(pos);
          });

          log("ğŸ“Œ ì•½êµ­ ë§ˆì»¤ ê°œìˆ˜:", list.length);
        } catch (e) {
          log("âŒ markersJson íŒŒì‹± ì‹¤íŒ¨:", e);
        }

        // ì „ì²´ê°€ ë‹¤ ë³´ì´ê²Œ
        map.setBounds(bounds);

        // ì¤Œ ë ˆë²¨ ì˜µì…˜ì´ ìˆìœ¼ë©´ ì ìš©
        if (typeof zoomLevel === "number") {
          map.setLevel(zoomLevel);
        } else {
          // ë„ˆë¬´ ë©€ë©´ ì¡°ê¸ˆ ë” í™•ëŒ€
          if (map.getLevel() > 5) {
            map.setLevel(5);
          }
        }
      };

      // âœ… íŠ¹ì • ì•½êµ­ìœ¼ë¡œ í™•ëŒ€í•´ì„œ ì´ë™ (ì¹´ë“œ íƒ­ìš©)
      window.focusOnPharmacy = function (lat, lng, zoomLevel) {
        if (!map) return;

        const pos = new kakao.maps.LatLng(lat, lng);
        map.setCenter(pos); // í•´ë‹¹ ì•½êµ­ìœ¼ë¡œ ì¤‘ì‹¬ ì´ë™

        if (typeof zoomLevel === "number") {
          map.setLevel(zoomLevel); // ë” í¬ê²Œ í™•ëŒ€ (ì˜ˆ: 3, 2 ë“±)
        }
      };

      document.addEventListener("DOMContentLoaded", function () {
        if (typeof kakao === "undefined") {
          log("âŒ kakao ì „ì—­ ê°ì²´ ì—†ìŒ (SDK ë¡œë“œ ì‹¤íŒ¨)");
          return;
        }
        initMap();
      });
    </script>
  </head>

  <body>
    <div id="map"></div>
  </body>
</html>
