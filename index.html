<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>Yakiyo Kakao Map</title>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100%;
      }
    </style>

    <!-- Kakao Maps JS SDK -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=76db1590d48d0c7bf7d8a1b4ce4147e4&autoload=false"></script>

    <script>
      let map = null;
      let markers = [];
      let myMarker = null; // ë‚´ ìœ„ì¹˜ ë§ˆì»¤

      function log() {
        console.log.apply(console, arguments);
      }

      // ì§€ë„ ì´ˆê¸°í™”
      function initMap() {
        kakao.maps.load(function () {
          const container = document.getElementById("map");
          const options = {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 2, // ê¸°ë³¸ í™•ëŒ€ ë ˆë²¨
          };
          map = new kakao.maps.Map(container, options);
          log("ğŸ—º Kakao Map ì´ˆê¸°í™” ì™„ë£Œ");
        });
      }

      // Flutter â†’ JS í•¨ìˆ˜
      window.setCenterAndMarkers = function (centerLat, centerLng, markersJson) {
        if (!map) {
          log("âš ï¸ map ì•„ì§ ì¤€ë¹„ ì•ˆ ë¨");
          return;
        }

        const center = new kakao.maps.LatLng(centerLat, centerLng);

        // ğŸ’¡ ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        markers.forEach((m) => m.setMap(null));
        markers = [];

        if (myMarker) {
          myMarker.setMap(null);
        }

        // â­ ë‚´ ìœ„ì¹˜ ë§ˆì»¤
        myMarker = new kakao.maps.Marker({
          map: map,
          position: center,
          title: "ë‚´ ìœ„ì¹˜",
        });

        // ì§€ë„ ë²”ìœ„ í¬í•¨ì‹œí‚¤ê¸°
        let bounds = new kakao.maps.LatLngBounds();
        bounds.extend(center);

        try {
          const list = JSON.parse(markersJson);

          list.forEach((item) => {
            const pos = new kakao.maps.LatLng(item.lat, item.lng);
            const marker = new kakao.maps.Marker({
              map: map,
              position: pos,
              title: item.name,
            });

            markers.push(marker);
            bounds.extend(pos);
          });

          log("ğŸ“Œ ì•½êµ­ ë§ˆì»¤ ê°œìˆ˜:", list.length);
        } catch (e) {
          log("âŒ markersJson íŒŒì‹± ì‹¤íŒ¨:", e);
        }

        // ğŸ” í™”ë©´ì— ëª¨ë“  ì  ë³´ì´ë„ë¡ ìë™ ì¡°ì ˆ
        map.setBounds(bounds);

        // ë„ˆë¬´ ë©€ë©´ ë ˆë²¨ ì¡°ì •
        if (map.getLevel() > 5) {
          map.setLevel(5);
        }
      };

      // DOM ë¡œë“œ
      document.addEventListener("DOMContentLoaded", function () {
        if (typeof kakao === "undefined") {
          log("âŒ Kakao SDK ë¡œë“œ ì‹¤íŒ¨");
          return;
        }
        initMap();
      });
    </script>
  </head>

  <body>
    <div id="map"></div>
  </body>
</html>
