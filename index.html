<script>
  let map = null;
  let markers = [];
  let myMarker = null; // ë‚´ ìœ„ì¹˜ ë§ˆì»¤

  function initMap() {
    kakao.maps.load(function () {
      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 3, // ğŸ” ê¸°ë³¸ ì¤Œ ì¡°ê¸ˆ ë” í™•ëŒ€
      };
      map = new kakao.maps.Map(container, options);
      console.log('Kakao Map ì´ˆê¸°í™” ì™„ë£Œ');
    });
  }

  window.setCenterAndMarkers = function (centerLat, centerLng, markersJson) {
    if (!map) {
      console.log('map ì•„ì§ ì¤€ë¹„ ì•ˆ ë¨');
      return;
    }

    const center = new kakao.maps.LatLng(centerLat, centerLng);

    // ì´ì „ ë§ˆì»¤ ì œê±°
    markers.forEach(m => m.setMap(null));
    markers = [];
    if (myMarker) {
      myMarker.setMap(null);
      myMarker = null;
    }

    // ğŸ”¹ ë‚´ ìœ„ì¹˜ ë§ˆì»¤
    myMarker = new kakao.maps.Marker({
      map: map,
      position: center,
      title: 'ë‚´ ìœ„ì¹˜',
    });

    let bounds = new kakao.maps.LatLngBounds();
    bounds.extend(center); // ë‚´ ìœ„ì¹˜ í¬í•¨

    try {
      const list = JSON.parse(markersJson);

      list.forEach(item => {
        const pos = new kakao.maps.LatLng(item.lat, item.lng);
        const marker = new kakao.maps.Marker({
          map: map,
          position: pos,
          title: item.name,
        });
        markers.push(marker);
        bounds.extend(pos); // ì•½êµ­ ìœ„ì¹˜ë„ boundsì— ì¶”ê°€
      });
    } catch (e) {
      console.log('markersJson íŒŒì‹± ì‹¤íŒ¨:', e);
    }

    // ğŸ” ëª¨ë“  ë§ˆì»¤ê°€ í™”ë©´ì— ë³´ì´ë„ë¡
    map.setBounds(bounds);

    // ê·¸ë˜ë„ ë„ˆë¬´ ë©€ë¦¬ ì¡íˆë©´ í•œ ë²ˆ ë” í™•ëŒ€
    if (map.getLevel() > 5) {
      map.setLevel(5);
    }
  };

  document.addEventListener('DOMContentLoaded', function () {
    if (typeof kakao === 'undefined') {
      console.log('kakao ì „ì—­ ê°ì²´ ì—†ìŒ (SDK ë¡œë“œ ì‹¤íŒ¨)');
      return;
    }
    initMap();
  });
</script>
